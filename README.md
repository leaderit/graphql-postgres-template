# GraphQL backend based on PostgreSQL database with Auth, Access rights and custom Business Logic

## Введение

Сервис интерфейса прикладнох программ на базе GraphQL интерфейса Hasura, сервера
SQL PostgreSQL и обработчика бизнес логики на базе NodeJS сервера Fastify собран 
для облегчения разработки серверной части для Web и мобильных приложений.

Выбранная комбинация серверных решений обладает следующими преимуществами.

- Высокая производительность
- Легкая расширяемость
- Поддержка внешних POST API
- Интеграция внешних GraphQL сервисов
- Подписка на обновления через Web Sockets
- Удобная GraphQL консоль для настройки и отладки запросов и данных
- Многое другое

## Настройка
### Файл конфигурации .env
Скопируйте файл с примером конфигурации `env-example` в файл с именем `.env`
и настройте парметры.

Установите имя вашего сервиса в списке контейнеров docker. Это имя используется как префикс
для всех образов сервиса.

    NAME=graphql-postgres-template

Установите значения паролей и портов чтобы иметь доступ извне к отдельным контейнерам.

### Запуск сервиса в режиме отладки

Для отладки необходимо запустить сервис в консольном режиме. 

    docker-compose up

При этом вы будете видеть все сообoщения служб на консоли. При обновлении
исходных текстовых файлов серверной части сервиса программа PM2
автоматически перестартует серверную часть и вы можете тестировать новый функционал.

### Запуск сервиса в режиме демона

В режиме демона сервис может быть запущен командой

    docker-compose up -d

### Настройка базы данных

После запуска сервисов будеет создана пустая база данных `PostgreSQL` в папке db/postgres
и `Redis` в папке db/redis.

Выполните создание таблиц, загрузку метаданных и данных по умолчанию для тестирования, 
введя команды:

    ./hasura-cli migrate apply
    ./hasura-cli metadata apply
    ./hasura-cli seeds apply

Повторный запуск команд на существующей базе данных может вызвать ошибку.

### Запуск тестов

Для того, чтобы убедиться, что ваши настройки выполнены правильно и сервисы работают корректно
запустите на настроенной базе занных тесты сервисов GraphQL API командой:

    ./run-tests 

Все тесты должны завершиться без ошибок.

### Роли и прива доступа

В сервисе используется ролевая модель доступа. Это означает, что все роли прописываются
при настройке сервиса и доступ к данным осуществляется на основе прав конкретной роли
пользователя, под которой он подключился к сервису.

Стандартные роли при создании сервиса следующие.

- admin
- anonymous
- user

Список ролей для назначения пользователям записан в таблице БД `roles`.
Этот список должен совпадать со списком ролей, прописанных в Hasura.

Вы можете добавить любые необходимые вам роли и настроить доступ к данным
в зависимости от того, какую роль доступа имеет пользователь.

Номера ролей с 1 по 999 зарезервированы для системных целей. Используйте
роли приложения начиная с номера 1000, который зарезервирован для 
простого пользователя без дополнительных полномочий.

##  Производственный режим

Загрузка на производственный сервер и настройка запуска.

## Перенос сервса на другой сервер

Так как сервис выполняется в контейнерах docker для переноса сервиса на новый сервер
вам достаточно 

- установить на нем docker и docker-compose
- скопировать папку вашего сервиса со всем содержимым на новый сервер
- корректно настроить файл .env на новый домен или сервер
- выполнить docker-compose up -d

## Обновление сервса на новую версию

Чтобы обновить сервис на новую версию вам необходимо выполнить следующие шаги.

- Сохранить ваши метаданные и базу данных старого сервера

    ./db-backup
    ./hasura-cli metadata export

- Скачать и установить чистый шаблон сервиса на вашем новом сервере.

    git clone https://github.com/leaderit/graphql-postgres-template
    # Переименовать папку шаблона в папку с именем сервиса вашего проекта
    mv graphql-postgres-template graphql-my-project

- Сохранить метаданные по умолчанию в другой папке

    mv ./db/metadata ./db/metadata.default

- Скопировать файлы `.env`, последний файл `*-backup.sql` и папку ./db/metadata на новый сервер

- настроить файл `.env` под новые сервер

- Исправить метаданные вручную, добавив в ваши метаданные необходимые дополнения из данных по умолчанию

- Исправить вручную ваши данные в файле `*-backup.sql`, добавив туда изменения структур из обновленной версии или создать специальную миграцию для обновления структуры

- Восстановить ваши метаданные

    ./hasura-cli metadata apply

- Восстановить данные

    ./db-restore [file name]-backup.sql

## Copyrights

(c) Valerii Grazhdankin, Moscow, Russia